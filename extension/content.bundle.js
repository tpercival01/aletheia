(()=>{window.addEventListener("DOMContentLoaded",()=>{console.log("Page loaded"),r()}),chrome.runtime.onMessage.addListener((s,a,l)=>{"RESET_PAGE_CONTENT"===s.type?(console.log("RESETTING"),function(){for(const e of t.data)document.evaluate(e.xpath,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue.style.setProperty("border","none","important");e=[],t=[],o=[],n=[]}(),l({status:"RESET_DONE"})):"SCAN_AGAIN"===s.type&&(console.log("SCANNING AGAIN"),r(),l({status:"COMPLETED"}))});let e=[],t=[],o=null,n=null;function r(){!function(){t=[];const e=["header","nav","footer","aside","script","style","noscript","button","meta","title","link","path","[role=banner]","[role=navigation]","[role=complementary]","[role=menubar]","[role=menu]","[aria-hidden=true]",".nav",".navbar",".menu",".header",".footer",".sidebar",".cookie",".popup",".modal",".ad",".advertisement"].join(","),o=["promoted","click here","read more","share","login","sign in","submit","privacy policy","user agreement","all rights reserved","learn more","t&cs apply","terms and conditions"],n=Array.from(document.querySelectorAll("*")).filter(t=>!t.matches(e)&&!t.closest(e)),r=new Set,s=new Map;t.length=0,n.forEach(e=>{const n=(e.innerText||e.textContent||"").replace(/\s+/g," ").trim();if(!n)return;if(n.split(" ").length<10)return;if(o.some(e=>n.toLowerCase().includes(e)))return;if(n===n.toUpperCase())return;const a=function(e){if(!e||e.nodeType!==Node.ELEMENT_NODE)return"";const t=[];let o=e;for(;o&&o.nodeType===Node.ELEMENT_NODE;){const e=o.tagName.toLowerCase();let n=e;const r=o.parentNode;if(r&&r.nodeType===Node.ELEMENT_NODE){const t=Array.from(r.children).filter(t=>t.nodeType===Node.ELEMENT_NODE&&t.tagName.toLowerCase()===e);t.length>1&&(n+=`[${t.indexOf(o)+1}]`)}t.unshift(n),o=r}return t.length>0?"/"+t.join("/"):""}(e);let l=!0;const i=[];for(let e of r)if(a.startsWith(e))i.push(e);else if(e.startsWith(a)){l=!1;break}if(i.forEach(e=>{r.delete(e);const o=s.get(e);if(void 0!==o){t.splice(o,1),s.delete(e);for(let[e,t]of s)t>o&&s.set(e,t-1)}}),l){r.add(a);const e=t.length;t.push({text:n,xpath:a}),s.set(a,e)}}),console.log(t)}(),async function(){console.log("sent payload");try{const o=await chrome.runtime.sendMessage({type:"PROCESS",payload:{text:{data:t,source:"content"},images:{data:e,source:"content"}}});console.log("received ",o);const n=o;t=n.text,function(e){if(e.text)for(const t of e.text.data){const e=document.evaluate(t.xpath,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;t.confidence>.8?e.style.setProperty("border","5px solid red","important"):t.confidence>.5&&e.style.setProperty("border","5px solid yellow","important")}else e.images&&console.log("images. no images.")}(n)}catch(e){console.log(e)}}()}})();